#!/bin/bash
remove_nat_rule() {
  for i in $(iptables -t nat -L PREROUTING --line-numbers | grep ipp2p | sort -r | awk '{ print $1 }')
  do
    iptables -t nat -D PREROUTING $i 2>/dev/null
  done
  for i in $(iptables -t nat -L OUTPUT --line-numbers | grep ipp2p | sort -r | awk '{ print $1 }')
  do
    iptables -t nat -D OUTPUT $i 2>/dev/null
  done
}

create_nat_rule() {
  remove_nat_rule
  iptables -t nat -I PREROUTING 1 -m ipp2p `uci -q get blockp2p.@settings[0].filter` -j `uci -q get blockp2p.@settings[0].action`
  iptables -t nat -I OUTPUT 1 -m ipp2p `uci -q get blockp2p.@settings[0].filter` -j `uci -q get blockp2p.@settings[0].action`
}

remove_mangle_rule() {
  for i in $(iptables -t mangle -L PREROUTING --line-numbers | grep ipp2p | sort -r | awk '{ print $1 }')
  do
    iptables -t mangle -D PREROUTING $i 2>/dev/null
  done
}

create_mangle_rule() {
  remove_mangle_rule
  iptables -t mangle -I PREROUTING 1 -p udp -m ipp2p `uci -q get blockp2p.@settings[0].filter` -j `uci -q get blockp2p.@settings[0].action`
}

while [ 1 ]; do
  if [ "$(uci -q get blockp2p.@settings[0].enable)" != "1" ]; then
    if [ -e /tmp/iptables_nat_sum ]; then
      rm -f /tmp/iptables_nat_sum
      iptables -t nat -D PREROUTING $(iptables -t nat -L PREROUTING --line-numbers | grep ipp2p | awk '{ print $1 }') 2>/dev/null
      iptables -t nat -D OUTPUT $(iptables -t nat -L OUTPUT --line-numbers | grep ipp2p | awk '{ print $1 }') 2>/dev/null
    fi
    if [ -e /tmp/iptables_mangle_sum ]; then
      rm -f /tmp/iptables_mangle_sum
    fi
  else
    nat_sum=`iptables -t nat -L -n | md5sum | awk '{print $1}'`
    touch /tmp/iptables_nat_sum
    old_nat_sum=$(cat /tmp/iptables_nat_sum)

    touch /tmp/iptables_mangle_sum
    mangle_sum=`iptables -t mangle -L -n | md5sum | awk '{print $1}'`
    old_mangle_sum=$(cat /tmp/iptables_mangle_sum)

    if [ "$nat_sum" != "$old_nat_sum" ]; then
      create_nat_rule
      echo $nat_sum > /tmp/iptables_nat_sum
    fi

    if [ "$mangle_sum" != "$old_mangle_sum" ]; then
      create_mangle_rule
      echo $mangle_sum > /tmp/iptables_mangle_sum
    fi
  fi

  sleep 5
done

exit 0
